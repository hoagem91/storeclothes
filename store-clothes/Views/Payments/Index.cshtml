@model store_clothes.Models.PaymentModel

@{
    ViewData["Title"] = "Thanh toán";
    var cartItems = Model.CartItems ?? new List<CartItem>();
    var total = cartItems.Sum(item => (item.Product.Price ?? 0) * item.Quantity);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="/css/checkout/checkout.css" /> 

<div class="container checkout-container">
    <div class="checkout-header">
        <h1 class="page-title">Thanh toán đơn hàng</h1>
        <p class="checkout-subtitle">Hoàn tất quá trình mua sắm của bạn</p>
    </div>

    <form asp-action="Index" method="post">
        <div class="row">
            <!-- Left: Cart items -->
            <div class="col-md-8">
                <div class="checkout-section">
                    <div class="section-title"><i class="bi bi-cart-fill"></i> Thông tin đơn hàng</div>
                    <div class="table-responsive">
                        <table class="table cart-table">
                            <thead>
                                <tr>
                                    <th>Ảnh</th>
                                    <th>Tên sản phẩm</th>
                                    <th>Giá</th>
                                    <th>Số lượng</th>
                                    <th>Tổng</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in cartItems)
                                {
                                    <tr>
                                        <td><img src="@item.Product.ImageUrl" alt="@item.Product.Name" class="product-img" /></td>
                                        <td><div class="product-name">@item.Product.Name</div></td>
                                        <td>@item.Product.Price?.ToString("N0") đ</td>
                                        <td>@item.Quantity</td>
                                        <td class="item-total">@((item.Product.Price ?? 0) * item.Quantity) đ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Tổng tiền sản phẩm:</span>
                            <span>@total.ToString("N0") đ</span>
                        </div>
                        <div class="summary-row">
                            <span>Phí vận chuyển:</span>
                            <span>0 đ</span>
                        </div>
                        <div class="summary-row total">
                            <span>Tổng thanh toán:</span>
                            <span>@total.ToString("N0") đ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Form -->
            <div class="col-md-4">
                <div class="checkout-section shipping-details">
                    <div class="section-title"><i class="bi bi-box-seam-fill"></i> Thông tin giao hàng</div>

                    <div class="form-group">
                        <label asp-for="FullName" class="form-label">Họ và tên</label>
                        <input asp-for="FullName" class="form-control" placeholder="Nhập họ và tên của bạn" />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Address" class="form-label">Địa chỉ</label>
                        <input asp-for="Address" class="form-control" placeholder="Nhập địa chỉ nhận hàng" />
                        <span asp-validation-for="Address" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Phone" class="form-label">Số điện thoại</label>
                        <input asp-for="Phone" class="form-control" placeholder="Nhập số điện thoại liên hệ" />
                        <span asp-validation-for="Phone" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="PaymentMethod" class="form-label">Phương thức thanh toán</label>
                        <select asp-for="PaymentMethod" class="form-select" id="PaymentMethod">
                            <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                            <option value="Banking">Chuyển khoản ngân hàng</option>
                        </select>
                        <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                    </div>

                    <div class="banking-info" id="bankingInfo" style="display:none;">
                        <div class="bank-details">
                            <p class="bank-title">Thông tin tài khoản:</p>
                            <p><strong>Ngân hàng:</strong> VIETCOMBANK</p>
                            <p><strong>Số tài khoản:</strong> 0123456789</p>
                            <p><strong>Chủ tài khoản:</strong> NGUYEN VAN A</p>
                            <p><strong>Nội dung:</strong> Thanh toan don hang #<span id="orderNumber">123456</span></p>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-checkout">Xác nhận thanh toán</button>
                </div>
            </div>
        </div>

        <!-- Overlay Success -->
        <div id="successOverlay" class="overlay">
            <div class="overlay-content">
                <h2>🎉 Thanh toán thành công!</h2>
                <p>Cảm ơn bạn đã mua hàng.</p>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Hiển thị thông tin chuyển khoản nếu chọn Banking
            $("#PaymentMethod").change(function () {
                if ($(this).val() === "Banking") {
                    $("#bankingInfo").slideDown();
                } else {
                    $("#bankingInfo").slideUp();
                }
            });

            // Hiển thị overlay + reset số liệu khi submit form
            $("form").submit(function (e) {
                e.preventDefault(); // Ngăn submit ngay

                // Hiển thị overlay
                $("#successOverlay").fadeIn();

                // Reset hiển thị giỏ hàng
                $(".cart-table tbody").empty(); // Xóa sản phẩm
                $(".summary-row span:nth-child(2)").text("0 đ"); // Tổng sản phẩm
                $(".summary-row.total span:nth-child(2)").text("0 đ"); // Tổng thanh toán

                // Gửi lại form sau 2 giây (tùy chọn)
                setTimeout(() => {
                    this.submit(); // Gửi thật
                }, 2000);
            });
        });
    </script>
}

